---
app-id: org.denemo.Denemo
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.texlive
command: denemo
finish-args:
  # Display
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=dri
  # Folder access
  - --filesystem=home
  - --filesystem=xdg-music
  # Needed for PortAudio/MIDI
  - --device=all
  # Needed for note playpack
  - --socket=pulseaudio
  # Needed for JACK over PipeWire
  - --filesystem=xdg-run/pipewire-0
  # required to find texlive binaries
  - --env=PATH=/app/texlive/bin/x86_64-linux:/app/texlive/bin/aarch64-linux:/app/bin:/usr/bin
modules:
  - name: guile
    buildsystem: autotools
    build-options:
      cflags: "-Wno-unused-but-set-variable -Wno-misleading-indentation
              -Wno-stringop-truncation -Wno-deprecated-declarations"
    config-opts:
      - --disable-error-on-warning
      - --disable-static
    # Patches copied from https://src.fedoraproject.org/rpms/compat-guile18/tree/master
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/guile/guile-1.8.8.tar.gz
        sha256: c3471fed2e72e5b04ad133bbaaf16369e8360283679bcf19800bc1b381024050
      - type: patch
        path: patches/guile-1.8.8-deplibs.patch
      - type: patch
        path: patches/guile-1.8.8-cve-2016-8605.patch
      - type: patch
        path: patches/guile-1.8.8-configure.patch
      # Files in the tarball are too old for aarch64 so we take them from the Sdk.
      - type: shell
        commands:
          - cp -fp /usr/share/automake-*/config.{sub,guess} build-aux/
          - cp -fp /usr/share/automake-*/config.{sub,guess} guile-readline/
    cleanup:
      - /include
      - /share/aclocal
      - /share/man

  # Fontforge build dependency
  - name: libuinameslist
    sources:
      - type: archive
        url: https://github.com/fontforge/libuninameslist/releases/download/20180701/libuninameslist-dist-20180701.tar.gz
        sha256: 8aed97d0bc872d893d8bf642a14e49958b0613136e1bfe2a415c69599c803c90
    cleanup:
      - "*"

  - name: fontforge
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DENABLE_DOCS=false
      - -DENABLE_LIBSPIRO=false
      - -DREAL_TYPE=double
    sources:
      - type: archive
        url: https://github.com/fontforge/fontforge/archive/20200314.tar.gz
        sha256: ad0eb017379c6f7489aa8e2d7c160f19140d1ac6351f20df1d9857d9428efcf2
    cleanup:
      - "*"

  - name: t1utils
    sources:
      - type: archive
        url: https://github.com/kohler/t1utils/archive/v1.41.tar.gz
        sha256: 0129fbfabb212143f52ff1e5de8ccbef5e5295d46772bad3ed149115bab5a094
    cleanup:
      - "*"

  - name: texgyre
    sources:
      - type: archive
        url: http://www.gust.org.pl/projects/e-foundry/tex-gyre/whole/tg2_501otf.zip
        sha256: d7f8be5317bec4e644cf16c5abf876abeeb83c43dbec0ccb4eee4516b73b1bbe
    buildsystem: simple
    build-commands:
      - mkdir /app/share/fonts
      - install * /app/share/fonts

  - name: ghostscript
    sources:
      - type: archive
        url: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9533/ghostscript-9.53.3.tar.xz
        sha256: 9c9f5bc85b6c7eb08368c05b1e3339f7aaf9677ddca710c6283f872d55e2a234
      - type: shell
        commands:
          - cp -p /usr/share/automake-*/config.{sub,guess} freetype/builds/unix/
          - cp -p /usr/share/automake-*/config.{sub,guess} ijs/
          - cp -p /usr/share/automake-*/config.{sub,guess} jpeg/
          - cp -p /usr/share/automake-*/config.{sub,guess} libpng/
          - cp -p /usr/share/automake-*/config.{sub,guess} lcms2mt/
          - cp -p /usr/share/automake-*/config.{sub,guess} tiff/config/
          - cp -p /usr/share/automake-*/config.{sub,guess} .
    config-opts:
      - --disable-cups
      - --disable-gtk
      - --enable-dynamic
    make-args:
      - so
    make-install-args:
      - soinstall
    cleanup:
      - /include
      - /share/doc
      - /share/man
      - /bin/gpcl6
      - /bin/gxps

  - name: lilypond
    buildsystem: autotools
    config-opts:
      - --disable-documentation
    sources:
      - type: archive
        url: https://lilypond.org/download/sources/v2.22/lilypond-2.22.2.tar.gz
        sha256: dde90854fa7de1012f4e1304a68617aea9ab322932ec0ce76984f60d26aa23be
      - type: shell
        commands:
          - cp -p /usr/share/automake-*/config.{sub,guess} config/
    build-options:
      arch:
        aarch64:
          prepend-path: /usr/lib/sdk/texlive/bin/aarch64-linux:/usr/lib/sdk/texlive/bin
        x86_64:
          prepend-path: /usr/lib/sdk/texlive/bin/x86_64-linux:/usr/lib/sdk/texlive/bin

  # Denemo requires intltool 0.35.0 or later.
  - shared-modules/intltool/intltool-0.51.json

  - name: aubio
    buildsystem: simple
    build-commands:
      - ./waf configure --prefix=/app --libdir=/app/lib
      - ./waf build -j $FLATPAK_BUILDER_N_JOBS
      - ./waf install
    sources:
      - type: archive
        url: https://aubio.org/pub/aubio-0.4.7.tar.bz2
        sha256: cbed4afec5ab3a1a6300c7e3af0a1369379aa94259f5e701a8ca905cdd9fa041
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/doc
      - "*.a"

  - name: gtksourceview3
    config-opts:
      - --enable-gtk-doc=no
      - --enable-introspection=yes
    cleanup:
      - /include
    sources:
      - type: archive
        url: https://download.gnome.org/sources/gtksourceview/3.24/gtksourceview-3.24.11.tar.xz
        sha256: 691b074a37b2a307f7f48edc5b8c7afa7301709be56378ccf9cc9735909077fd

  - name: Boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app
      - ./b2 install --build-type=complete link=shared --layout=versioned runtime-link=shared cxxflags="$CXXFLAGS" linkflags="$LDFLAGS" -j $FLATPAK_BUILDER_N_JOBS
    cleanup:
      - /include
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.76.0/source/boost_1_76_0.tar.bz2
        sha256: f0397ba6e982c4450f27bf32a2a83292aba035b827a5623a14636ea583318c41

  - name: poppler-data
    no-autogen: true
    make-install-args:
      - prefix=/app
    sources:
      - type: archive
        url: https://poppler.freedesktop.org/poppler-data-0.4.10.tar.gz
        sha256: 6e2fcef66ec8c44625f94292ccf8af9f1d918b410d5aa69c274ce67387967b30

  - name: poppler
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_INSTALL_LIBDIR=/app/lib
      - -DCMAKE_INSTALL_INCLUDEDIR=/app/include
      - -DENABLE_LIBOPENJPEG=none
    cleanup:
      - /bin
      - /include
      - /share/pkgconfig
    sources:
      - type: archive
        url: https://poppler.freedesktop.org/poppler-21.07.0.tar.xz
        sha256: e26ab29f68065de4d6562f0a3e2b5435a83ca92be573b99a1c81998fa286a4d4

  - name: evince
    buildsystem: meson
    config-opts:
      - -Dcomics=disabled
      - -Dnautilus=false
      - -Dviewer=false
      - -Dpreviewer=false
      - -Ddbus=false
      #- -Dbrowser-plugin=false
      - -Dthumbnail_cache=disabled
      - -Dgtk_doc=false
      - -Duser_doc=false
      - -Dintrospection=true
      - -Dsystemduserunitdir=no
    cleanup:
      - /include
      - /lib/pkgconfig
      - /man
      - /share/applications
      - /share/GConf
      - /share/help
      - /share/man
      - /share/metainfo
    sources:
      - type: archive
        url: https://download.gnome.org/sources/evince/40/evince-40.4.tar.xz
        sha256: 33420500e0e060f178a435063197d42dae7b67e39cc437a96510a33ddf7e95fb
      - type: shell
        commands:
          # Remove libhandy dep, not needed with -Dviewer=false
          - sed -i '/hdy_dep/d' meson.build
          # Remove adwaita-icon-theme support, not needed with -Dviewer=false
          - sed -i '/adwaita_icon_them/d' meson.build
          # Force evince to use internal_synctex (make it no find the external one)
          - sed -i 's/1.19/8.88/g' meson.build

  - name: fluidsynth
    buildsystem: cmake-ninja
    config-opts:
      - -DLIB_SUFFIX=
      - -DCMAKE_BUILD_TYPE=Release
    cleanup:
      - /include
      - /share/man
    sources:
      - type: archive
        url: https://github.com/FluidSynth/fluidsynth/archive/v1.1.11.tar.gz
        sha256: da8878ff374d12392eecf87e96bad8711b8e76a154c25a571dd8614d1af80de8

  - name: vamp-plugin-sdk
    sources:
      - type: archive
        # Official site currently fails with ssl error, use a mirror
        #url: https://code.soundsoftware.ac.uk/attachments/download/2450/vamp-plugin-sdk-2.8.0.tar.gz
        url: https://mirror.sobukus.de/files/src/vamp-plugin-sdk/vamp-plugin-sdk-2.8.0.tar.gz
        sha256: dcc96ae894795822398789f251c2c7effa602fc60e9dd6c7a5c5d2e7a513526c
    post-install:
      - install -Dm644 -t /app/share/licenses/vamp-plugin-sdk COPYING
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/licenses
      - "*.a"

  - name: rubberband
    build-options:
      env:
        Vamp_CFLAGS: " "
        Vamp_LIBS: " "
    sources:
      - type: archive
        url: https://code.breakfastquay.com/attachments/download/34/rubberband-1.8.1.tar.bz2
        sha256: ff0c63b0b5ce41f937a8a3bc560f27918c5fe0b90c6bc1cb70829b86ada82b75
    post-install:
      - install -Dm644 -t /app/share/licenses/rubberband COPYING
    cleanup:
      - /include
      - /share/ladspa
      - /share/licenses
      - "*.a"

  - name: portaudio
    buildsystem: cmake-ninja
    cleanup:
      - /include
    sources:
      - type: archive
        url: http://files.portaudio.com/archives/pa_stable_v190700_20210406.tgz
        sha256: 47efbf42c77c19a05d22e627d42873e991ec0c1357219c0d74ce6a2948cb2def

  - name: portmidi
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_LIBRARY_OUTPUT_DIRECTORY=/app/lib
      - -DCMAKE_ARCHIVE_OUTPUT_DIRECTORY=/app/lib
      - -DCMAKE_RUNTIME_OUTPUT_DIRECTORY=/app/bin
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/portmedia/portmidi/217/portmidi-src-217.zip
        sha256: 08e9a892bd80bdb1115213fb72dc29a7bf2ff108b378180586aa65f3cfd42e0f
      - type: patch
        path: patches/portmidi-no-java.patch
    cleanup:
      - /bin
      - /include

  - name: denemo
    sources:
      - type: archive
        url: http://ftp.gnu.org/gnu/denemo/denemo-2.6.0.tar.gz
        sha256: 4be5970c69847f97f1f876275c9744e5034e7c983b12a1045fb20c236494b55d
      # For a possible alternative, see https://github.com/flathub/org.freedesktop.appstream.cli/issues/1
      - type: patch
        path: patches/denemo-metainfo-add-2.6.0-release.patch
    post-install:
      # Flatpak expects the icon to be under /app/share/icons
      - mv ${FLATPAK_DEST}/share/pixmaps/org.denemo.Denemo.png ${FLATPAK_DEST}/share/icons/hicolor/64x64/apps/org.denemo.Denemo.png

